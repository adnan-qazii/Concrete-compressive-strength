{% extends "base.html" %}

{% block title %}Live Monitor - ConcreteML AI Platform{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header animate__animated animate__fadeInDown">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">
                <i class="fas fa-chart-line"></i> Live Monitor
            </h1>
            <p class="text-muted mb-0">Real-time Pipeline Execution Tracking</p>
        </div>
        <div class="text-end">
            <button id="refreshBtn" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <div class="small text-muted mt-1">Auto-refresh: <span id="autoRefreshStatus" class="text-success">ON</span></div>
        </div>
    </div>
</div>

<!-- Status Cards Row -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stat-card animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
            <div class="stat-icon">
                <i id="statusIcon" class="fas fa-{{ 'spinner fa-spin' if status.running else 'check' if status.completed and not status.error else 'times' if status.error else 'play' }}"></i>
            </div>
            <div id="statusText" class="stat-number">
                {% if status.running %}
                    Running
                {% elif status.completed %}
                    {% if status.error %}
                        Failed
                    {% else %}
                        Complete
                    {% endif %}
                {% else %}
                    Ready
                {% endif %}
            </div>
            <div class="stat-label">Pipeline Status</div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stat-card animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
            <div class="stat-icon">
                <i class="fas fa-tasks"></i>
            </div>
            <div id="currentStepText" class="stat-number">
                {{ status.current_step.replace('_', ' ').title() if status.current_step else 'Idle' }}
            </div>
            <div class="stat-label">Current Step</div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stat-card animate__animated animate__fadeInUp" style="animation-delay: 0.3s;">
            <div class="stat-icon">
                <i class="fas fa-percentage"></i>
            </div>
            <div id="progressText" class="stat-number">
                {{ (status.progress / status.total_steps * 100) | round(1) if status.total_steps > 0 else 0 }}%
            </div>
            <div class="stat-label">Progress</div>
            <small id="progressSteps" class="text-info">{{ status.progress }}/{{ status.total_steps }} steps</small>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stat-card animate__animated animate__fadeInUp" style="animation-delay: 0.4s;">
            <div class="stat-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div id="timeText" class="stat-number">
                {% if status.start_time %}
                    Running
                {% else %}
                    ---
                {% endif %}
            </div>
            <div class="stat-label">Execution Time</div>
            <small id="timeDetails" class="text-info">
                {% if status.start_time %}
                    Started: {{ status.start_time }}
                {% else %}
                    Not started
                {% endif %}
            </small>
        </div>
    </div>
</div>

<!-- Progress Bar -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card animate__animated animate__fadeInUp" style="animation-delay: 0.5s;">
            <div class="card-header">
                <h5>
                    <i class="fas fa-tasks text-primary"></i>
                    Pipeline Progress
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-bold">Overall Progress</span>
                    <span id="overallProgress" class="badge bg-primary">
                        {{ status.progress }}/{{ status.total_steps }} Steps
                    </span>
                </div>
                <div class="progress mb-3" style="height: 20px;">
                    <div id="mainProgressBar" class="progress-bar">
                        <span class="fw-bold" id="progressPercentText">0%</span>
                    </div>
                </div>
                
                <!-- Step Details -->
                <div class="row">
                    {% set step_names = ['Data Ingestion', 'Feature Selection', 'Data Processing', 'Model Training', 'Hyperparameter Tuning', 'Final Training', 'Evaluation'] %}
                    {% for i in range(7) %}
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-2">
                        <div class="d-flex align-items-center">
                            <i id="step{{ i+1 }}Icon" class="fas fa-{{ 'check text-success' if status.progress > i else 'circle text-muted' }} me-2"></i>
                            <small class="step-label">{{ step_names[i] }}</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Live Logs -->
<div class="row">
    <div class="col-12">
        <div class="card animate__animated animate__fadeInUp" style="animation-delay: 0.6s;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>
                    <i class="fas fa-terminal text-success"></i>
                    Live Execution Logs
                </h5>
                <div>
                    <button id="clearLogsBtn" class="btn btn-sm btn-outline-warning">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                    <button id="downloadLogsBtn" class="btn btn-sm btn-outline-info">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="logsContainer" class="logs-terminal">
                    {% if status.logs %}
                        {% for log in status.logs %}
                            <div class="log-entry">{{ log }}</div>
                        {% endfor %}
                    {% else %}
                        <div class="log-entry text-muted">
                            <i class="fas fa-info-circle"></i> Waiting for pipeline execution...
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Control Panel -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card animate__animated animate__fadeInUp" style="animation-delay: 0.7s;">
            <div class="card-header">
                <h5>
                    <i class="fas fa-gamepad text-warning"></i>
                    Control Panel
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-4 col-md-6 mb-3">
                        <div class="d-grid">
                            <a href="{{ url_for('index') }}" class="btn btn-primary btn-lg">
                                <i class="fas fa-home"></i>
                                Back to Dashboard
                            </a>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6 mb-3">
                        <div class="d-grid">
                            <a href="{{ url_for('results') }}" class="btn btn-success btn-lg">
                                <i class="fas fa-chart-bar"></i>
                                View Results
                            </a>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6 mb-3">
                        <div class="d-grid">
                            <a href="{{ url_for('predict') }}" class="btn btn-info btn-lg">
                                <i class="fas fa-brain"></i>
                                Make Prediction
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Real-time Stats -->
                <div class="row mt-4 pt-3 border-top">
                    <div class="col-md-3 col-6 text-center">
                        <div class="text-primary fw-bold fs-5" id="refreshCount">0</div>
                        <small class="text-muted">Refreshes</small>
                    </div>
                    <div class="col-md-3 col-6 text-center">
                        <div class="text-success fw-bold fs-5" id="logCount">{{ status.logs|length }}</div>
                        <small class="text-muted">Log Entries</small>
                    </div>
                    <div class="col-md-3 col-6 text-center">
                        <div class="text-warning fw-bold fs-5" id="uptimeText">00:00</div>
                        <small class="text-muted">Monitoring Time</small>
                    </div>
                    <div class="col-md-3 col-6 text-center">
                        <div class="text-info fw-bold fs-5">Auto</div>
                        <small class="text-muted">Refresh Mode</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.logs-terminal {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: #00ff00;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    height: 500px;
    overflow-y: auto;
    padding: 20px;
    border-radius: 10px;
    position: relative;
}

.logs-terminal::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 30px;
    background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3);
    background-size: 400% 400%;
    animation: gradientShift 3s ease infinite;
}

@keyframes gradientShift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

.log-entry {
    margin-bottom: 8px;
    padding: 5px 10px;
    border-radius: 5px;
    transition: all 0.3s ease;
    line-height: 1.4;
}

.log-entry:hover {
    background: rgba(0, 255, 0, 0.1);
}

.log-entry:contains("✅") {
    color: #00ff88;
    background: rgba(0, 255, 136, 0.1);
}

.log-entry:contains("❌") {
    color: #ff6b6b;
    background: rgba(255, 107, 107, 0.1);
}

.log-entry:contains("🚀") {
    color: #4ecdc4;
    background: rgba(78, 205, 196, 0.1);
}

.log-entry:contains("🎉") {
    color: #ffe66d;
    background: rgba(255, 230, 109, 0.1);
}

.step-label {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

@media (max-width: 768px) {
    .logs-terminal {
        height: 300px;
        font-size: 12px;
        padding: 15px;
    }
}

/* Pulse animation for running status */
.pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* Typing animation for new logs */
.log-entry.new {
    animation: typeIn 0.5s ease-out;
}

@keyframes typeIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}
</style>
{% endblock %}

{% block scripts %}
<!-- Hidden data elements for JavaScript -->
<div id="statusData" 
     data-progress="{{ status.progress if status.progress else 0 }}"
     data-total-steps="{{ status.total_steps if status.total_steps else 1 }}"
     style="display: none;"></div>

<script>
let refreshCount = 0;
let startTime = Date.now();
let autoRefresh = true;
let refreshInterval;

// Initialize progress bar from data
function initializeProgress() {
    const statusData = document.getElementById('statusData');
    if (statusData) {
        const progress = parseInt(statusData.dataset.progress);
        const totalSteps = parseInt(statusData.dataset.totalSteps);
        const percentage = totalSteps > 0 ? (progress / totalSteps * 100) : 0;
        
        const progressBar = document.getElementById('mainProgressBar');
        const progressText = document.getElementById('progressPercentText');
        if (progressBar && progressText) {
            progressBar.style.width = percentage + '%';
            progressText.textContent = percentage.toFixed(1) + '%';
        }
    }
}

function updateStatus() {
    fetch('/status')
        .then(response => response.json())
        .then(data => {
            refreshCount++;
            document.getElementById('refreshCount').textContent = refreshCount;
            
            // Update status icon and text
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            
            if (data.running) {
                statusIcon.className = 'fas fa-spinner fa-spin pulse';
                statusText.textContent = 'Running';
                statusText.className = 'stat-number text-warning';
            } else if (data.completed) {
                if (data.error) {
                    statusIcon.className = 'fas fa-times';
                    statusText.textContent = 'Failed';
                    statusText.className = 'stat-number text-danger';
                } else {
                    statusIcon.className = 'fas fa-check';
                    statusText.textContent = 'Complete';
                    statusText.className = 'stat-number text-success';
                }
            } else {
                statusIcon.className = 'fas fa-play';
                statusText.textContent = 'Ready';
                statusText.className = 'stat-number text-primary';
            }
            
            // Update current step
            document.getElementById('currentStepText').textContent = 
                data.current_step ? data.current_step.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Idle';
            
            // Update progress
            const progress = data.total_steps > 0 ? (data.progress / data.total_steps * 100) : 0;
            document.getElementById('progressText').textContent = progress.toFixed(1) + '%';
            document.getElementById('progressSteps').textContent = `${data.progress}/${data.total_steps} steps`;
            document.getElementById('overallProgress').textContent = `${data.progress}/${data.total_steps} Steps`;
            
            // Update progress bar
            const progressBar = document.getElementById('mainProgressBar');
            progressBar.style.width = progress + '%';
            progressBar.innerHTML = `<span class="fw-bold">${progress.toFixed(1)}%</span>`;
            
            // Update step icons
            for (let i = 1; i <= 7; i++) {
                const stepIcon = document.getElementById(`step${i}Icon`);
                if (stepIcon) {
                    if (data.progress >= i) {
                        stepIcon.className = 'fas fa-check text-success me-2';
                    } else if (data.progress === i - 1 && data.running) {
                        stepIcon.className = 'fas fa-spinner fa-spin text-warning me-2';
                    } else {
                        stepIcon.className = 'fas fa-circle text-muted me-2';
                    }
                }
            }
            
            // Update logs
            const logsContainer = document.getElementById('logsContainer');
            const currentLogCount = logsContainer.children.length;
            const newLogCount = data.logs.length;
            
            if (newLogCount > currentLogCount) {
                // Add new logs
                for (let i = currentLogCount; i < newLogCount; i++) {
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry new';
                    logEntry.textContent = data.logs[i];
                    logsContainer.appendChild(logEntry);
                }
                // Scroll to bottom
                logsContainer.scrollTop = logsContainer.scrollHeight;
            } else if (newLogCount !== currentLogCount) {
                // Replace all logs
                logsContainer.innerHTML = data.logs.map(log => 
                    `<div class="log-entry">${log}</div>`
                ).join('');
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
            
            // Update log count
            document.getElementById('logCount').textContent = data.logs.length;
            
            // Update execution time
            if (data.start_time) {
                document.getElementById('timeText').textContent = 'Running';
                document.getElementById('timeDetails').textContent = `Started: ${data.start_time}`;
            } else {
                document.getElementById('timeText').textContent = '---';
                document.getElementById('timeDetails').textContent = 'Not started';
            }
        })
        .catch(error => {
            console.error('Error fetching status:', error);
            // Show connection error in logs
            const logsContainer = document.getElementById('logsContainer');
            const errorEntry = document.createElement('div');
            errorEntry.className = 'log-entry text-danger';
            errorEntry.innerHTML = '<i class="fas fa-wifi"></i> Connection error - retrying...';
            logsContainer.appendChild(errorEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        });
}

function updateUptime() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('uptimeText').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function startAutoRefresh() {
    if (refreshInterval) clearInterval(refreshInterval);
    refreshInterval = setInterval(updateStatus, 2000);
    autoRefresh = true;
    document.getElementById('autoRefreshStatus').textContent = 'ON';
    document.getElementById('autoRefreshStatus').className = 'text-success';
}

function stopAutoRefresh() {
    if (refreshInterval) clearInterval(refreshInterval);
    autoRefresh = false;
    document.getElementById('autoRefreshStatus').textContent = 'OFF';
    document.getElementById('autoRefreshStatus').className = 'text-danger';
}

// Manual refresh button
document.getElementById('refreshBtn').addEventListener('click', () => {
    updateStatus();
    // Add rotation animation
    const btn = document.getElementById('refreshBtn');
    const icon = btn.querySelector('i');
    icon.style.animation = 'spin 0.5s linear';
    setTimeout(() => icon.style.animation = '', 500);
});

// Clear logs button
document.getElementById('clearLogsBtn').addEventListener('click', () => {
    const logsContainer = document.getElementById('logsContainer');
    logsContainer.innerHTML = '<div class="log-entry text-muted"><i class="fas fa-info-circle"></i> Logs cleared by user</div>';
    document.getElementById('logCount').textContent = '1';
});

// Download logs button
document.getElementById('downloadLogsBtn').addEventListener('click', () => {
    fetch('/status')
        .then(response => response.json())
        .then(data => {
            const logs = data.logs.join('\n');
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pipeline_logs_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
        });
});

// Toggle auto-refresh on click
document.getElementById('autoRefreshStatus').addEventListener('click', () => {
    if (autoRefresh) {
        stopAutoRefresh();
    } else {
        startAutoRefresh();
    }
});

// Initial setup
initializeProgress();
updateStatus();
startAutoRefresh();
setInterval(updateUptime, 1000);

// Stop auto-refresh when page is hidden
document.addEventListener('visibilitychange', () => {
    if (document.hidden && autoRefresh) {
        stopAutoRefresh();
    } else if (!document.hidden && !autoRefresh) {
        startAutoRefresh();
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    if (e.ctrlKey || e.metaKey) {
        switch (e.key) {
            case 'r':
                e.preventDefault();
                updateStatus();
                break;
            case 'k':
                e.preventDefault();
                document.getElementById('clearLogsBtn').click();
                break;
        }
    }
});
</script>

<style>
@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}
