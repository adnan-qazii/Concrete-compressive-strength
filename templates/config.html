{% extends "base.html" %}

{% block title %}Configuration - ConcreteML AI Platform{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header animate__animated animate__fadeInDown">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">
                <i class="fas fa-cogs"></i> Pipeline Configuration
            </h1>
            <p class="text-muted mb-0">Customize your machine learning pipeline settings</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="loadDefaults()">
                <i class="fas fa-undo"></i> Reset to Defaults
            </button>
            <button class="btn btn-primary" onclick="saveConfiguration()">
                <i class="fas fa-save"></i> Save Configuration
            </button>
        </div>
    </div>
</div>

<!-- Configuration Form -->
<form id="configForm" onsubmit="event.preventDefault(); saveConfiguration();">
    <div class="row">
        <!-- Data Processing Settings -->
        <div class="col-lg-6 mb-4">
            <div class="card animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-database text-primary"></i>
                        Data Processing
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="test_size" class="form-label">
                            <i class="fas fa-chart-pie"></i> Test Set Size
                            <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <input type="range" class="form-range" id="test_size" min="0.1" max="0.4" step="0.05" value="0.2" oninput="updateRangeLabel(this, 'test_size_label')">
                            <span class="input-group-text" id="test_size_label">20%</span>
                        </div>
                        <small class="form-text text-muted">Percentage of data reserved for testing</small>
                    </div>

                    <div class="mb-3">
                        <label for="random_state" class="form-label">
                            <i class="fas fa-dice"></i> Random State
                        </label>
                        <input type="number" class="form-control" id="random_state" value="42" min="1" max="1000">
                        <small class="form-text text-muted">For reproducible results</small>
                    </div>

                    <div class="mb-3">
                        <label for="scaling_method" class="form-label">
                            <i class="fas fa-balance-scale"></i> Feature Scaling
                        </label>
                        <select class="form-select" id="scaling_method">
                            <option value="standard">StandardScaler (Z-score normalization)</option>
                            <option value="minmax">MinMaxScaler (0-1 scaling)</option>
                            <option value="robust">RobustScaler (Median-based)</option>
                            <option value="none">No Scaling</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="feature_engineering" checked>
                            <label class="form-check-label" for="feature_engineering">
                                <i class="fas fa-tools"></i> Enable Feature Engineering
                            </label>
                        </div>
                        <small class="form-text text-muted">Create interaction features and ratios</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Training Settings -->
        <div class="col-lg-6 mb-4">
            <div class="card animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-robot text-success"></i>
                        Model Training
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-brain"></i> Models to Train
                        </label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="model_rf" value="random_forest" checked>
                            <label class="form-check-label" for="model_rf">
                                ðŸŒ² Random Forest
                                <small class="text-muted d-block">Ensemble of decision trees</small>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="model_xgb" value="xgboost" checked>
                            <label class="form-check-label" for="model_xgb">
                                ðŸš€ XGBoost
                                <small class="text-muted d-block">Gradient boosting framework</small>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="model_et" value="extra_trees" checked>
                            <label class="form-check-label" for="model_et">
                                ðŸŒ³ Extra Trees
                                <small class="text-muted d-block">Extremely randomized trees</small>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="model_lgb" value="lightgbm">
                            <label class="form-check-label" for="model_lgb">
                                âš¡ LightGBM
                                <small class="text-muted d-block">Fast gradient boosting</small>
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="cv_folds" class="form-label">
                            <i class="fas fa-layer-group"></i> Cross-Validation Folds
                        </label>
                        <input type="number" class="form-control" id="cv_folds" value="5" min="3" max="10">
                        <small class="form-text text-muted">Number of folds for cross-validation</small>
                    </div>

                    <div class="mb-3">
                        <label for="scoring_metric" class="form-label">
                            <i class="fas fa-target"></i> Primary Scoring Metric
                        </label>
                        <select class="form-select" id="scoring_metric">
                            <option value="r2">RÂ² Score (Coefficient of Determination)</option>
                            <option value="neg_mean_squared_error">Negative MSE</option>
                            <option value="neg_root_mean_squared_error">Negative RMSE</option>
                            <option value="neg_mean_absolute_error">Negative MAE</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hyperparameter Tuning -->
        <div class="col-lg-6 mb-4">
            <div class="card animate__animated animate__fadeInUp" style="animation-delay: 0.3s;">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-sliders-h text-warning"></i>
                        Hyperparameter Tuning
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enable_tuning" checked>
                            <label class="form-check-label" for="enable_tuning">
                                <i class="fas fa-magic"></i> Enable Hyperparameter Optimization
                            </label>
                        </div>
                    </div>

                    <div id="tuning_options">
                        <div class="mb-3">
                            <label for="tuning_method" class="form-label">
                                <i class="fas fa-search"></i> Optimization Method
                            </label>
                            <select class="form-select" id="tuning_method">
                                <option value="random">RandomizedSearchCV</option>
                                <option value="grid">GridSearchCV</option>
                                <option value="bayesian">Bayesian Optimization</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="n_iter" class="form-label">
                                <i class="fas fa-redo-alt"></i> Number of Iterations
                            </label>
                            <div class="input-group">
                                <input type="range" class="form-range" id="n_iter" min="50" max="1000" step="50" value="200" oninput="updateRangeLabel(this, 'n_iter_label')">
                                <span class="input-group-text" id="n_iter_label">200</span>
                            </div>
                            <small class="form-text text-muted">More iterations = better results but longer runtime</small>
                        </div>

                        <div class="mb-3">
                            <label for="n_jobs" class="form-label">
                                <i class="fas fa-microchip"></i> Parallel Jobs
                            </label>
                            <select class="form-select" id="n_jobs">
                                <option value="-1">Use all CPU cores</option>
                                <option value="1">Single core</option>
                                <option value="2">2 cores</option>
                                <option value="4">4 cores</option>
                                <option value="8">8 cores</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Output & Logging -->
        <div class="col-lg-6 mb-4">
            <div class="card animate__animated animate__fadeInUp" style="animation-delay: 0.4s;">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt text-info"></i>
                        Output & Logging
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="output_dir" class="form-label">
                            <i class="fas fa-folder"></i> Output Directory
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="output_dir" value="results/" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="selectOutputDir()">
                                <i class="fas fa-folder-open"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="log_level" class="form-label">
                            <i class="fas fa-terminal"></i> Logging Level
                        </label>
                        <select class="form-select" id="log_level">
                            <option value="INFO">INFO - Standard logging</option>
                            <option value="DEBUG">DEBUG - Detailed logging</option>
                            <option value="WARNING">WARNING - Only warnings and errors</option>
                            <option value="ERROR">ERROR - Only errors</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="save_models" checked>
                            <label class="form-check-label" for="save_models">
                                <i class="fas fa-save"></i> Save Trained Models
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="generate_plots" checked>
                            <label class="form-check-label" for="generate_plots">
                                <i class="fas fa-chart-line"></i> Generate Visualization Plots
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="detailed_reports" checked>
                            <label class="form-check-label" for="detailed_reports">
                                <i class="fas fa-file-pdf"></i> Generate Detailed Reports
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Settings (Collapsible) -->
    <div class="card mb-4 animate__animated animate__fadeInUp" style="animation-delay: 0.5s;">
        <div class="card-header">
            <h5 class="mb-0">
                <button class="btn btn-link text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#advancedSettings">
                    <i class="fas fa-cogs text-secondary"></i>
                    Advanced Settings
                    <i class="fas fa-chevron-down ms-2"></i>
                </button>
            </h5>
        </div>
        <div class="collapse" id="advancedSettings">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">
                            <i class="fas fa-filter"></i> Data Filtering
                        </h6>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="remove_outliers" checked>
                                <label class="form-check-label" for="remove_outliers">
                                    Remove Statistical Outliers
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="outlier_threshold" class="form-label">Outlier Threshold (IQR)</label>
                            <input type="number" class="form-control" id="outlier_threshold" value="1.5" step="0.1" min="1.0" max="3.0">
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h6 class="text-success">
                            <i class="fas fa-memory"></i> Performance
                        </h6>
                        <div class="mb-3">
                            <label for="memory_limit" class="form-label">Memory Limit (GB)</label>
                            <input type="number" class="form-control" id="memory_limit" value="8" min="1" max="64">
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="early_stopping" checked>
                                <label class="form-check-label" for="early_stopping">
                                    Enable Early Stopping
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row">
        <div class="col-12">
            <div class="card animate__animated animate__fadeInUp" style="animation-delay: 0.6s;">
                <div class="card-body text-center">
                    <div class="d-grid gap-3 d-md-flex justify-content-md-center">
                        <button type="button" class="btn btn-outline-secondary btn-lg" onclick="previewConfig()">
                            <i class="fas fa-eye"></i> Preview Configuration
                        </button>
                        <button type="button" class="btn btn-warning btn-lg" onclick="loadDefaults()">
                            <i class="fas fa-undo"></i> Reset to Defaults
                        </button>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save"></i> Save & Apply Configuration
                        </button>
                        <a href="{{ url_for('index') }}" class="btn btn-success btn-lg">
                            <i class="fas fa-rocket"></i> Run Pipeline with Config
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Configuration Preview Modal -->
<div class="modal fade" id="configPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-code"></i> Configuration Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="config-preview">
                    <pre><code id="configPreviewContent"></code></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="downloadConfig()">
                    <i class="fas fa-download"></i> Download YAML
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.config-preview {
    background: #1a1a2e;
    color: #00ff00;
    font-family: 'Courier New', monospace;
    padding: 20px;
    border-radius: 10px;
    max-height: 400px;
    overflow-y: auto;
}

.config-preview::-webkit-scrollbar {
    width: 8px;
}

.config-preview::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
}

.config-preview::-webkit-scrollbar-thumb {
    background: #00ff00;
    border-radius: 10px;
}

.form-range {
    margin-right: 10px;
}

.input-group .form-range {
    border: none;
    flex: 1;
}

.form-check-label small {
    font-size: 0.8em;
    opacity: 0.7;
}

#tuning_options {
    transition: all 0.3s ease;
}

@media (max-width: 768px) {
    .config-preview {
        font-size: 12px;
        padding: 15px;
        max-height: 300px;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Initialize form interactions
document.addEventListener('DOMContentLoaded', function() {
    // Load saved configuration
    loadConfiguration();
    
    // Toggle tuning options based on checkbox
    document.getElementById('enable_tuning').addEventListener('change', function() {
        const tuningOptions = document.getElementById('tuning_options');
        tuningOptions.style.opacity = this.checked ? '1' : '0.5';
        tuningOptions.style.pointerEvents = this.checked ? 'auto' : 'none';
    });
});

function updateRangeLabel(range, labelId) {
    const label = document.getElementById(labelId);
    const value = parseFloat(range.value);
    
    if (labelId === 'test_size_label') {
        label.textContent = Math.round(value * 100) + '%';
    } else {
        label.textContent = value.toString();
    }
}

function loadDefaults() {
    // Reset all form fields to default values
    document.getElementById('test_size').value = 0.2;
    document.getElementById('random_state').value = 42;
    document.getElementById('scaling_method').value = 'standard';
    document.getElementById('feature_engineering').checked = true;
    
    document.getElementById('model_rf').checked = true;
    document.getElementById('model_xgb').checked = true;
    document.getElementById('model_et').checked = true;
    document.getElementById('model_lgb').checked = false;
    document.getElementById('cv_folds').value = 5;
    document.getElementById('scoring_metric').value = 'r2';
    
    document.getElementById('enable_tuning').checked = true;
    document.getElementById('tuning_method').value = 'random';
    document.getElementById('n_iter').value = 200;
    document.getElementById('n_jobs').value = '-1';
    
    document.getElementById('output_dir').value = 'results/';
    document.getElementById('log_level').value = 'INFO';
    document.getElementById('save_models').checked = true;
    document.getElementById('generate_plots').checked = true;
    document.getElementById('detailed_reports').checked = true;
    
    document.getElementById('remove_outliers').checked = true;
    document.getElementById('outlier_threshold').value = 1.5;
    document.getElementById('memory_limit').value = 8;
    document.getElementById('early_stopping').checked = true;
    
    // Update range labels
    updateRangeLabel(document.getElementById('test_size'), 'test_size_label');
    updateRangeLabel(document.getElementById('n_iter'), 'n_iter_label');
    
    // Show success message
    showNotification('Configuration reset to defaults!', 'success');
}

function loadConfiguration() {
    // In a real implementation, this would load from backend
    const savedConfig = localStorage.getItem('mlPipelineConfig');
    if (savedConfig) {
        try {
            const config = JSON.parse(savedConfig);
            // Apply saved configuration to form fields
            showNotification('Previous configuration loaded!', 'info');
        } catch (e) {
            console.log('No valid saved configuration found');
        }
    }
}

function saveConfiguration() {
    const config = {
        data_processing: {
            test_size: parseFloat(document.getElementById('test_size').value),
            random_state: parseInt(document.getElementById('random_state').value),
            scaling_method: document.getElementById('scaling_method').value,
            feature_engineering: document.getElementById('feature_engineering').checked,
            remove_outliers: document.getElementById('remove_outliers').checked,
            outlier_threshold: parseFloat(document.getElementById('outlier_threshold').value)
        },
        model_training: {
            models: {
                random_forest: document.getElementById('model_rf').checked,
                xgboost: document.getElementById('model_xgb').checked,
                extra_trees: document.getElementById('model_et').checked,
                lightgbm: document.getElementById('model_lgb').checked
            },
            cv_folds: parseInt(document.getElementById('cv_folds').value),
            scoring_metric: document.getElementById('scoring_metric').value
        },
        hyperparameter_tuning: {
            enabled: document.getElementById('enable_tuning').checked,
            method: document.getElementById('tuning_method').value,
            n_iter: parseInt(document.getElementById('n_iter').value),
            n_jobs: document.getElementById('n_jobs').value === '-1' ? -1 : parseInt(document.getElementById('n_jobs').value)
        },
        output: {
            output_dir: document.getElementById('output_dir').value,
            log_level: document.getElementById('log_level').value,
            save_models: document.getElementById('save_models').checked,
            generate_plots: document.getElementById('generate_plots').checked,
            detailed_reports: document.getElementById('detailed_reports').checked
        },
        performance: {
            memory_limit: parseInt(document.getElementById('memory_limit').value),
            early_stopping: document.getElementById('early_stopping').checked
        }
    };
    
    // Save to localStorage
    localStorage.setItem('mlPipelineConfig', JSON.stringify(config));
    
    // Save to backend (in real implementation)
    fetch('/save_config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        showNotification('Configuration saved successfully!', 'success');
    })
    .catch(error => {
        console.error('Error saving configuration:', error);
        showNotification('Configuration saved locally (server unavailable)', 'warning');
    });
}

function previewConfig() {
    const config = getConfigObject();
    const yamlContent = generateYAML(config);
    
    document.getElementById('configPreviewContent').textContent = yamlContent;
    
    const modal = new bootstrap.Modal(document.getElementById('configPreviewModal'));
    modal.show();
}

function getConfigObject() {
    return {
        data_processing: {
            test_size: parseFloat(document.getElementById('test_size').value),
            random_state: parseInt(document.getElementById('random_state').value),
            scaling_method: document.getElementById('scaling_method').value,
            feature_engineering: document.getElementById('feature_engineering').checked,
            remove_outliers: document.getElementById('remove_outliers').checked,
            outlier_threshold: parseFloat(document.getElementById('outlier_threshold').value)
        },
        model_training: {
            models: {
                random_forest: document.getElementById('model_rf').checked,
                xgboost: document.getElementById('model_xgb').checked,
                extra_trees: document.getElementById('model_et').checked,
                lightgbm: document.getElementById('model_lgb').checked
            },
            cv_folds: parseInt(document.getElementById('cv_folds').value),
            scoring_metric: document.getElementById('scoring_metric').value
        },
        hyperparameter_tuning: {
            enabled: document.getElementById('enable_tuning').checked,
            method: document.getElementById('tuning_method').value,
            n_iter: parseInt(document.getElementById('n_iter').value),
            n_jobs: document.getElementById('n_jobs').value === '-1' ? -1 : parseInt(document.getElementById('n_jobs').value)
        },
        output: {
            output_dir: document.getElementById('output_dir').value,
            log_level: document.getElementById('log_level').value,
            save_models: document.getElementById('save_models').checked,
            generate_plots: document.getElementById('generate_plots').checked,
            detailed_reports: document.getElementById('detailed_reports').checked
        },
        performance: {
            memory_limit: parseInt(document.getElementById('memory_limit').value),
            early_stopping: document.getElementById('early_stopping').checked
        }
    };
}

function generateYAML(config) {
    return `# ConcreteML AI Platform Configuration
# Generated: ${new Date().toLocaleString()}

data_processing:
  test_size: ${config.data_processing.test_size}
  random_state: ${config.data_processing.random_state}
  scaling_method: "${config.data_processing.scaling_method}"
  feature_engineering: ${config.data_processing.feature_engineering}
  remove_outliers: ${config.data_processing.remove_outliers}
  outlier_threshold: ${config.data_processing.outlier_threshold}

model_training:
  models:
    random_forest: ${config.model_training.models.random_forest}
    xgboost: ${config.model_training.models.xgboost}
    extra_trees: ${config.model_training.models.extra_trees}
    lightgbm: ${config.model_training.models.lightgbm}
  cv_folds: ${config.model_training.cv_folds}
  scoring_metric: "${config.model_training.scoring_metric}"

hyperparameter_tuning:
  enabled: ${config.hyperparameter_tuning.enabled}
  method: "${config.hyperparameter_tuning.method}"
  n_iter: ${config.hyperparameter_tuning.n_iter}
  n_jobs: ${config.hyperparameter_tuning.n_jobs}

output:
  output_dir: "${config.output.output_dir}"
  log_level: "${config.output.log_level}"
  save_models: ${config.output.save_models}
  generate_plots: ${config.output.generate_plots}
  detailed_reports: ${config.output.detailed_reports}

performance:
  memory_limit: ${config.performance.memory_limit}
  early_stopping: ${config.performance.early_stopping}`;
}

function downloadConfig() {
    const config = getConfigObject();
    const yamlContent = generateYAML(config);
    
    const blob = new Blob([yamlContent], { type: 'text/yaml' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `config_${new Date().toISOString().slice(0, 10)}.yaml`;
    a.click();
    window.URL.revokeObjectURL(url);
    
    showNotification('Configuration downloaded!', 'success');
}

function selectOutputDir() {
    // In a real implementation, this would open a directory picker
    showNotification('Directory picker would open here', 'info');
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}
</script>
{% endblock %}
